# file_upload
一个文件分块上传案例

已实现：分块上传，断点续传，联网续传，暂停，控制并发，实时刷新上传网速和上传进度

由前端和后端组成，前端只使用到基础的jquery，后端用php实现，由于只是演示，故数据库使用的是sqlite，数据库ORM类使用的是RedBeanPHP，可以很方便得支持到mysql。数据库表有两个，upload_info存储文件信息，upload_tmp存储分块文件，sql语句在database.sql。

技术点
1）上传速度实时刷新使用的是xhr:xhrOnProgress机制实现，他会在文件上传时实时触发进度回调，这帮助实现了网速计算和进度实时刷新。

2）暂停和停止功能是通过xhr的abort方法实现的，但整块上传不适用暂停。

3）断点续传依靠后端记录已上传部分的数据实现，也就是不管在哪个进度停掉，比如突然断网或关闭页面，下次只要上传的还是同一个文件（也就是文件md5值一样），都能从已上传部分继续衔接上传。

4）断网后重新联网将自动续传，通过window的offline和online事件实现。

5）分块上传支持并发数控制，其核心就是控制xhr的请求数量，如果不控制，对服务端来说一旦服务器过忙很可能导致大量超时，对客户端来说并发数过多会造成页面卡顿。

6）md5计算使用的是spark-md5，他是异步的，耗时的，需做好等待处理。

7）上传过程分两步，第1步是获取已存在的文件信息，第2步才是上传文件，第1步的目的是认证，容量确认，获取文件id，获取之前已上传的文件的信息，这一步不可忽略。

8）【启动合并】使用的php文件函数file_put_contents()逐个追加的，如果文件过多此处可能会成为性能瓶颈导致超时。要达到商用级别还是需要进行优化一下，比如把合并独立成异步任务


